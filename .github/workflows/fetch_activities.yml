# ÌååÏùº Í≤ΩÎ°ú: .github/workflows/fetch_commits.yml

name: Fetch GitHub Activities (Commits, Issues, Releases)

on:
  push:
    branches:
      - main
    # üö® Î¨¥Ìïú Î£®ÌîÑ Î∞©ÏßÄ: ÏÑ∏ ÌååÏùº Î™®Îëê Ï†úÏô∏
    paths-ignore:
      - '_data/commits_data.json'
      - '_data/issues_data.json'
      - '_data/releases_data.json'
      
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' 
    
permissions:
  contents: write

# concurrency:
#   group: fetch_activities_group # Í∑∏Î£π Ïù¥Î¶Ñ Î≥ÄÍ≤Ω
#   cancel-in-progress: true

jobs:
  fetch_and_save:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ACTIONS_DEPLOY_KEY }} 

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.ACTIONS_DEPLOY_KEY }}
          fetch-depth: 0 

      - name: Install dependencies
        run: sudo apt-get install -y jq

      # üö® ÌÜµÌï©: Ïª§Î∞ã, Ïù¥Ïäà/PR, Î¶¥Î¶¨Ï¶à Îç∞Ïù¥ÌÑ∞Î•º Î™®Îëê Í∞ÄÏ†∏ÏòµÎãàÎã§.
      - name: Fetch and process activities
        id: fetch
        env:
          GITHUB_USERNAME: sunbang123
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Í∏∞Î≥∏ ÏÑ§Ï†ï
          REPOS_URL="https://api.github.com/users/${GITHUB_USERNAME}/repos?sort=pushed&direction=desc"
          EXCLUDED_REPO="${GITHUB_USERNAME}.github.io" 

          # 1. Î¶¨Ìè¨ÏßÄÌÜ†Î¶¨ Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞ Î∞è GitHub Pages Ï†úÏô∏
          REPO_NAMES_RAW=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" "$REPOS_URL")
          
          if echo "$REPO_NAMES_RAW" | jq -e '.[].name' > /dev/null 2>&1; then
              REPO_NAMES=$(echo "$REPO_NAMES_RAW" | jq -r '.[].name' | grep -v -w "$EXCLUDED_REPO")
          else
              echo "Error: Failed to fetch repositories. Check username or API Rate Limit."
              echo "API Response: $REPO_NAMES_RAW"
              exit 1 
          fi

          # =========================================================
          # A. Ïª§Î∞ã Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Î°úÏßÅ
          # =========================================================
          TEMP_COMMITS_FILE=$(mktemp)
          echo "[]" > "$TEMP_COMMITS_FILE"
          
          for REPO_NAME in $REPO_NAMES; do
              COMMITS_URL="https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/commits?per_page=5"
              COMMITS_RAW_DATA=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" "$COMMITS_URL")
              
              if echo "$COMMITS_RAW_DATA" | jq -e '.[0].sha' > /dev/null 2>&1; then
                  COMMITS_ARRAY=$(echo "$COMMITS_RAW_DATA" | jq -c --arg repo "$REPO_NAME" '
                      [.[] | {
                          type: "commit",
                          repo: $repo,
                          message: .commit.message, 
                          author: .commit.author.name, 
                          date: .commit.author.date,
                          sha: .sha
                      }]
                  ')
                  jq -s '.[0] + .[1]' "$TEMP_COMMITS_FILE" <(echo "$COMMITS_ARRAY") > "${TEMP_COMMITS_FILE}.new"
                  mv "${TEMP_COMMITS_FILE}.new" "$TEMP_COMMITS_FILE"
              fi
          done
          
          # =========================================================
          # B. Ïù¥Ïäà/PR Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Î°úÏßÅ
          # =========================================================
          TEMP_ISSUES_FILE=$(mktemp)
          echo "[]" > "$TEMP_ISSUES_FILE"

          for REPO_NAME in $REPO_NAMES; do
              ISSUES_URL="https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/issues?state=all&per_page=5"
              ISSUES_RAW_DATA=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" "$ISSUES_URL")

              if echo "$ISSUES_RAW_DATA" | jq -e '.[0].title' > /dev/null 2>&1; then
                  ISSUES_ARRAY=$(echo "$ISSUES_RAW_DATA" | jq -c --arg repo "$REPO_NAME" '
                      [.[] | {
                          type: (if .pull_request then "pull_request" else "issue" end), 
                          repo: $repo,
                          title: .title,
                          state: .state,
                          date: .created_at,
                          url: .html_url,
                          number: .number
                      }]
                  ')
                  jq -s '.[0] + .[1]' "$TEMP_ISSUES_FILE" <(echo "$ISSUES_ARRAY") > "${TEMP_ISSUES_FILE}.new"
                  mv "${TEMP_ISSUES_FILE}.new" "$TEMP_ISSUES_FILE"
              fi
          done
          
          # =========================================================
          # C. Î¶¥Î¶¨Ï¶à Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Î°úÏßÅ (ÏÉàÎ°ú Ï∂îÍ∞Ä)
          # =========================================================
          TEMP_RELEASES_FILE=$(mktemp)
          echo "[]" > "$TEMP_RELEASES_FILE"

          for REPO_NAME in $REPO_NAMES; do
              RELEASES_URL="https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/releases?per_page=5"
              RELEASES_RAW_DATA=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" "$RELEASES_URL")

              if echo "$RELEASES_RAW_DATA" | jq -e '.[0].tag_name' > /dev/null 2>&1; then
                  RELEASES_ARRAY=$(echo "$RELEASES_RAW_DATA" | jq -c --arg repo "$REPO_NAME" '
                      [.[] | {
                          type: "release", 
                          repo: $repo,
                          tag: .tag_name,
                          name: .name,
                          date: .published_at, # Î¶¥Î¶¨Ï¶à Í≤åÏãú ÏãúÍ∞Ñ ÏÇ¨Ïö©
                          url: .html_url,
                          author: .author.login
                      }]
                  ')
                  jq -s '.[0] + .[1]' "$TEMP_RELEASES_FILE" <(echo "$RELEASES_ARRAY") > "${TEMP_RELEASES_FILE}.new"
                  mv "${TEMP_RELEASES_FILE}.new" "$TEMP_RELEASES_FILE"
              fi
          done


          # =========================================================
          # D. ÏµúÏ¢Ö Ï†ïÎ¶¨ Î∞è Ï†ÄÏû•
          # =========================================================
          mkdir -p _data
          CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # 1. Ïª§Î∞ã Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
          FINAL_COMMITS=$(jq 'sort_by(.date) | reverse | . + [{"last_updated": $time}]' --arg time "$CURRENT_TIME" "$TEMP_COMMITS_FILE")
          echo "$FINAL_COMMITS" > _data/commits_data.json
          
          # 2. Ïù¥Ïäà/PR Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
          FINAL_ISSUES=$(jq 'sort_by(.date) | reverse | . + [{"last_updated": $time}]' --arg time "$CURRENT_TIME" "$TEMP_ISSUES_FILE")
          echo "$FINAL_ISSUES" > _data/issues_data.json

          # 3. Î¶¥Î¶¨Ï¶à Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
          FINAL_RELEASES=$(jq 'sort_by(.date) | reverse | . + [{"last_updated": $time}]' --arg time "$CURRENT_TIME" "$TEMP_RELEASES_FILE")
          echo "$FINAL_RELEASES" > _data/releases_data.json
          
          # ÏûÑÏãú ÌååÏùº ÏÇ≠Ï†ú
          rm -f "$TEMP_COMMITS_FILE" "$TEMP_ISSUES_FILE" "$TEMP_RELEASES_FILE"
          
          echo "Successfully processed commit, issue, PR, and release data."
          
      # 5. Î≥ÄÍ≤ΩÎêú JSON ÌååÏùºÏùÑ ÏûêÎèô Ïª§Î∞ã Î∞è Ìë∏Ïãú
      - name: Commit and push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Automatic commit: Update recent GitHub activities data"
          files: |
            _data/commits_data.json
            _data/issues_data.json
            _data/releases_data.json
