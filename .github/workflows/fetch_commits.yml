# íŒŒì¼ ê²½ë¡œ: .github/workflows/fetch_commits.yml
name: Fetch GitHub Commits

on:
  # 'on' í•˜ìœ„ í•­ëª©ì€ ëª¨ë‘ ê°™ì€ ë ˆë²¨ë¡œ ë“¤ì—¬ì“°ê¸° í•´ì•¼ í•©ë‹ˆë‹¤.
  push:
    branches:
      # ì‚¬ìš©í•˜ëŠ” ì£¼ ë¸Œëœì¹˜ê°€ 'master'ê°€ ì•„ë‹Œ 'main'ì´ë¼ë©´ 'main'ìœ¼ë¡œ ìˆ˜ì •í•˜ì„¸ìš”.
      - master 
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ì„ ìœ„í•œ íŠ¸ë¦¬ê±°
  schedule:
    - cron: '0 0 * * *' # ë§¤ì¼ ìì •ì— ìë™ ì‹¤í–‰

jobs:
  fetch_and_save:
    runs-on: ubuntu-latest
    steps:
      # 1. SSH í‚¤ ì„¤ì •
      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          # ğŸ‘‡ ë“±ë¡í•œ Secret ì´ë¦„ê³¼ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ”ì§€ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.
          ssh-private-key: ${{ secrets.DEPLOY_KEY }} 

      # 2. ì½”ë“œ ì²´í¬ì•„ì›ƒ (SSHë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}
          fetch-depth: 0 

      - name: Install dependencies
        run: sudo apt-get install -y jq

      # 3. Fetch and process commits
      - name: Fetch and process commits
        id: fetch
        env:
          GITHUB_USERNAME: sunbang123
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Actions ê¸°ë³¸ í† í° ì‚¬ìš© (ì•ˆì „)
        run: |
          REPOS_URL="https://api.github.com/users/${GITHUB_USERNAME}/repos?type=owner"
          REPO_NAMES=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" $REPOS_URL | jq -r '.[].name')
          
          ALL_COMMITS="[]"
          
          for REPO_NAME in $REPO_NAMES; do
              COMMITS_URL="https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/commits?per_page=5"
              
              COMMITS=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" $COMMITS_URL | jq --arg repo "$REPO_NAME" '.[] | {
                  repo: $repo,
                  message: .commit.message, 
                  author: .commit.author.name, 
                  date: .commit.author.date,
                  sha: .sha
              }')
              
              if [ -n "$COMMITS" ]; then
                  for COMMIT in $COMMITS; do
                      ALL_COMMITS=$(echo "$ALL_COMMITS" | jq --argjson commit "$COMMIT" '. + [$commit]')
                  done
              fi
          done
          
          FINAL_DATA=$(echo "$ALL_COMMITS" | jq 'sort_by(.date) | reverse')

          mkdir -p _data
          echo "$FINAL_DATA" > _data/commits_data.json
          
      # 5. ì»¤ë°‹ ë° í‘¸ì‹œ
      - name: Commit and push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Automatic commit: Update recent GitHub activity data"
          files: _data/commits_data.json
