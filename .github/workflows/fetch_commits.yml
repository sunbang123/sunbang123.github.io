# 파일 경로: .github/workflows/fetch_commits.yml
name: Fetch GitHub Commits

on:
  # 'on' 하위 항목은 모두 같은 레벨로 들여쓰기 해야 합니다.
  push:
    branches:
      # 사용하는 주 브랜치가 'master'가 아닌 'main'이라면 'main'으로 수정하세요.
      - master 
  workflow_dispatch: # 수동 실행을 위한 트리거
  schedule:
    - cron: '0 0 * * *' # 매일 자정에 자동 실행
    
permissions:
  contents: write
  
jobs:
  fetch_and_save:
    runs-on: ubuntu-latest
    steps:
      # 1. SSH 키 설정
      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ACTIONS_DEPLOY_KEY }} 

      # 2. 코드 체크아웃 (SSH를 사용하도록 설정)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.ACTIONS_DEPLOY_KEY }}
          fetch-depth: 0 

      - name: Install dependencies
        run: sudo apt-get install -y jq

# 3. Fetch and process commits
      - name: Fetch and process commits
        id: fetch
        env:
          GITHUB_USERNAME: sunbang123
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPOS_URL="https://api.github.com/users/${GITHUB_USERNAME}/repos?type=owner"
          REPO_NAMES=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" $REPOS_URL | jq -r '.[].name')
          
          ALL_COMMITS="[]"
          
          for REPO_NAME in $REPO_NAMES; do
              COMMITS_URL="https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/commits?per_page=5"
              
              COMMITS_RAW_DATA=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" $COMMITS_URL | jq -c --arg repo "$REPO_NAME" '
                  .[] | {
                      repo: $repo,
                      message: .commit.message, 
                      author: .commit.author.name, 
                      date: .commit.author.date,
                      sha: .sha
                  }
              ')
              
              if [ -n "$COMMITS_RAW_DATA" ]; then
                  NEW_COMMITS_ARRAY=$(echo "$COMMITS_RAW_DATA" | jq -s '.')
                  
                  ALL_COMMITS=$(echo "$ALL_COMMITS" | jq --argjson new_commits "$NEW_COMMITS_ARRAY" '. + $new_commits')
              fi
          done
          
          # 최종 데이터를 날짜 역순으로 정렬합니다.
          FINAL_DATA=$(echo "$ALL_COMMITS" | jq 'sort_by(.date) | reverse')
          
          mkdir -p _data
          echo "$FINAL_DATA" > _data/commits_data.json
          
      # 5. 커밋 및 푸시
      - name: Commit and push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Automatic commit: Update recent GitHub activity data"
          files: _data/commits_data.json
